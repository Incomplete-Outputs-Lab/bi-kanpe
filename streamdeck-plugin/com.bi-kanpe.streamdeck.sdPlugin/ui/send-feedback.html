<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Send Feedback Settings</title>
  <link rel="stylesheet" href="sdpi.css">
</head>
<body>
  <div class="sdpi-wrapper">
    <div class="sdpi-item">
      <div class="sdpi-item-label">ã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ‰ãƒ¬ã‚¹</div>
      <input class="sdpi-item-value" type="text" id="serverAddress" placeholder="localhost:9877">
    </div>

    <div class="sdpi-item">
      <div class="sdpi-item-label">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¿ã‚¤ãƒ—</div>
      <select class="sdpi-item-value select" id="feedbackType">
        <option value="Ack">äº†è§£ (Ack)</option>
        <option value="Question">è³ªå• (Question)</option>
        <option value="Issue">å•é¡Œ (Issue)</option>
        <option value="Info">æƒ…å ± (Info)</option>
      </select>
    </div>

    <div class="sdpi-item">
      <div class="sdpi-item-label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹</div>
      <textarea class="sdpi-item-value" id="content" rows="4" placeholder="é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
    </div>

    <div class="sdpi-item">
      <details class="message">
        <summary>ğŸ’¡ ä½¿ã„æ–¹</summary>
        <p>
          <strong>ã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ‰ãƒ¬ã‚¹:</strong> Bi-Kanpeã‚­ãƒ£ã‚¹ã‚¿ãƒ¼ã‚¢ãƒ—ãƒªã§è¨­å®šã—ãŸStreamDeckã‚µãƒ¼ãƒãƒ¼ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒãƒ¼ãƒˆç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: localhost:9877ï¼‰<br><br>
          <strong>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¿ã‚¤ãƒ—:</strong> é€ä¿¡ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„<br><br>
          <strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹:</strong> ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼ã«é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
        </p>
      </details>
    </div>
  </div>

  <script>
    // Get action settings
    const $serverAddress = document.getElementById('serverAddress');
    const $feedbackType = document.getElementById('feedbackType');
    const $content = document.getElementById('content');

    // Connect to Stream Deck
    const websocket = new WebSocket('ws://127.0.0.1:23654');
    let actionInfo;
    let uuid;
    let settings = {};

    websocket.onopen = function() {
      const json = {
        event: 'registerPropertyInspector',
        uuid: getQueryParam('registerPropertyInspector')
      };
      websocket.send(JSON.stringify(json));
    };

    websocket.onmessage = function(evt) {
      const jsonObj = JSON.parse(evt.data);
      const event = jsonObj.event;
      const payload = jsonObj.payload;

      if (event === 'didReceiveSettings') {
        settings = payload.settings;
        updateUI();
      }
    };

    function updateUI() {
      $serverAddress.value = settings.serverAddress || 'localhost:9877';
      $feedbackType.value = settings.feedbackType || 'Ack';
      $content.value = settings.content || '';
    }

    function saveSettings() {
      settings.serverAddress = $serverAddress.value;
      settings.feedbackType = $feedbackType.value;
      settings.content = $content.value;

      const json = {
        event: 'setSettings',
        context: uuid,
        payload: settings
      };
      websocket.send(JSON.stringify(json));
    }

    // Add event listeners
    $serverAddress.addEventListener('input', saveSettings);
    $feedbackType.addEventListener('change', saveSettings);
    $content.addEventListener('input', saveSettings);

    // Helper to get query parameters
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Store context UUID
    uuid = getQueryParam('registerPropertyInspector');
  </script>
</body>
</html>
